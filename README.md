# esgf_wms

### modify_catalogs.py

This script modifies THREDDS XML catalogs to add aggregate datasets with
WMS/WCS/OpenDAP access.

This script modifies THREDDS xml catalogs generated by the ESGF publisher to
remove ESGF-specific markup, and optionally creates NcML aggregations and makes
these accessible through OPeNDAP/WMS/WCS.

Install requirements with `pip install -r requirements.txt` (create and activate a python3
virtualenv first).

To run, first create directories `input_catalogs`, `output_catalogs` and `aggregations`.
Running `./modify_catalogs.py -a` will read the catalogs `input_catalogs/esacci*.xml`, make the
necessary changes, and write the modified catalogs to `output_catalogs`.

If `--aggregate` is used, NcML files for the aggregate datasets will be saved in `aggregations` and
OPeNDAP endpoints are added.

(The directory names `input_catalogs`, `output_catalogs` and `aggregations` can be overridden with
the `--input-dir`, `--output-dir` and `--ncml-dir` options respectively)

Use `--wms` to additionally create WMS/WCS endpoints.

By defalt the code assumes that the files and directories created in `aggregations` will be placed
under `/usr/local/aggregations` on the live server.

### partition_files.py

Usage: `./partition_files.py <outdir>`.

Read file paths from standard input and partitions them into groups of files that can likely be
aggregated based on their filenames. These groups are written to files `<outdir>/1`, `<outdir>/2`
etc...

### aggregate.py

Read file paths from standard input (one per line) and write an NcML aggregation of those files to
standard output.

### agg_wrapper.sh

A convenience script `./agg_wrapper.sh <dir>` finds NetCDF files in `<dir>`, runs
`partition_files.py` on the list and `aggregate.py` on each output.

## Tests

`tests.py` contains some *very simple* tests - to run:

* Create a directory `test_input_catalogs` containing an un-modified THREDDS
  catalog (this is used as a base catalog to modify during the tests - but the
  modified catalog will *not* be written to disk)
* Run `pytest tests.py`.

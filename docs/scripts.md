# Scripts

`publish.sh` calls lots of python scripts throughout the process, some of
which are in the [tds-utils](https://github.com/cedadev/tds-utils) repository.
Scripts from `esacci-esgf` are documented below.

Each scipt accepts `-h` or `--help` for exact usage.

## modify_catalogs

This script modifies THREDDS xml catalogs generated by the ESGF publisher to
remove ESGF-specific markup, and optionally creates NcML aggregations and makes
these accessible through OPeNDAP/WMS/WCS.

Basic usage: `modify_catalogs <catalog> [<catalog> ...]`

This will process the catalog(s) given and write the modified catalog(s) to a
file in `output_catalogs` with the same basename as `<catalog>`.

If `--aggregate` is used, NcML files for the aggregate datasets will be saved
in `aggregations` and OPeNDAP endpoints are added. Use `--wms` to additionally
create WMS/WCS endpoints.

The directory names `input_catalogs`, `output_catalogs` and `aggregations` can
be overridden with the `--input-dir`, `--output-dir` and `--ncml-dir` options
respectively.

By default the code assumes that the files and directories created in
`aggregations` will be placed under `/usr/local/aggregations` on the live server
- this can be changed with `--remote-agg-dir`.

A link to the THREDDS catalog is written to the 'history' global attribute in
aggregations. The hostname for the remote THREDDS server can be given with
`--server`.

## make_mapfiles

This script generates ESGF mapfiles from a JSON file in
['dataset JSON'](input_files.md#dataset-json) format.

Usage: `make_mapfiles <input JSON> <root output dir>`.

Mapfiles will be written in directories under `<root output dir>`, and the
paths to the generated files are written to stdout.

## get_catalogs

Usage: `get_catalogs -o <outdir> -n <ncml dir> -e <path to esg.ini> [<input JSON>...]`.

This script is a wrapper around `modify_catalogs.py` that takes input JSON in
['dataset JSON'](input_files.md#dataset-json) format, finds the location of
THREDDS catalogs produced by the publisher for each dataset, and runs
`modify_catalogs.py` with appropriate arguments.

The modified catalogs are saved under `<outdir>` and the directory structure of
the THREDDS root dir (i.e. the directory under which the publisher writes the
catalogs) is preserved.

The top level catalog is also copied to `<outdir>/catalog.xml`.

If no JSON files are given then only the top level catalog is copied.

It must be run after the first step of publication since the THREDDS catalogs
need to exist and be recorded in the publication database.

The DB connection URL and root THREDDS directory is obtained from an INI file,
the path to which must be given on the command line. This file must at least
contain a `DEFAULT` section containing the following:

```ini
[DEFAULT]
dburl = postgresql://user:password@host/dbname
thredds_root = /path/to/thredds/root
```

(any extra sections and settings are ignored, so the full `esg.ini` can be
used)

## merge_csv_json

Usage: `merge_csv_json <input CSV>`.

Read a CSV file containing information about datasets to be published and
print JSON in ['dataset JSON'](input_files.md#dataset-json) format to stdout.

## transfer_catalogs

This script manages THREDDS catalogs and NcML aggregations on a remote THREDDS
server. It supports copying content from the local machine, deleting content on
the remote machine, and retrieving content from the remote machine.

Usage:

`transfer_catalogs [-c <catalog>] [-n <ncml>] (copy | delete | retrieve)`

When copying, `<catalog>` and `<ncml>` should be local files or directories
that are to be copied.

When deleting, `<catalog>` and `<ncml>` should be paths of files on the
remote server relative to the THREDDS/NcML root directories (given by
`--remote-catalog-dir` and `--remote-agg-dir`).

Both `-c` and `-n` can be used multiple times when copying or deleting.

When retrieving, `<catalog>` and `<ncml>` are interpreted in the same way
as with deletion. Exactly one catalog or NcML file must be specified. The
file's contents is written to stdout.

The server hostname and user to connect as can be changed with `-s` and `-u`
respectively.

## get_catalog_path

Usage: `get_catalog_path -e <path to esg.ini> <dataset name>`

Query the publication database to find the path of a THREDDS catalog relative
to the THREDDS root.

## parse_esg_ini

Usage `parse_esg_ini <path to esg.ini> (thredds_host | thredds_root | thredds_password | thredds_data_path | thredds_username | solr_host | publication_db_url)`

Parse an ESGF ini config file and extract a value.

## remove_key

Usage: `remove_key <key> <json file>`.

Remove a key from the top level of a JSON dictionary, and print the new
dictionary to stdout.
